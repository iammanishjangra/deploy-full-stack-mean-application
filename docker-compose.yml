version: "3.9"

services:
  # MongoDB Database
  mongodb:
    image: mongo:latest
    container_name: crud-mongodb
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - custom-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Node.js / Express Backend
  backend:
    image: manishjangra97/full-stack-mean-application-backend:latest
    container_name: crud-backend
    restart: unless-stopped
    # environment:
    #   - PORT=8080
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - custom-network

  # Angular Frontend
  frontend:
    image: manishjangra97/full-stack-mean-application-frontend:latest
    container_name: crud-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - custom-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:stable-alpine
    container_name: crud-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - custom-network

volumes:
  mongo_data:
    name: mongo_data

networks:
  custom-network:
    driver: bridge
    name: custom-network
